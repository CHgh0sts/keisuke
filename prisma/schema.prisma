// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Utilisateurs
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   @default("OPERATOR") // ADMIN, SUPERVISOR, OPERATOR
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reports         Report[]        @relation("ReportCreator")
  assignedReports Report[]        @relation("ReportAssignee")
  sentMessages    Message[]       @relation("MessageSender")
  conversations   ConversationParticipant[]
  readMessages    MessageRead[]

  @@map("users")
}

// Équipes (liées aux quais)
model Team {
  id        String   @id @default(cuid())
  name      String   @unique
  quaiId    String?
  quai      Quai?    @relation(fields: [quaiId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  invitationTokens  InvitationToken[]
  conversations     Conversation[]

  @@map("teams")
}

// Tokens d'invitation
model InvitationToken {
  id        String    @id @default(cuid())
  token     String    @unique
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  role      String    @default("OPERATOR") // Rôle attribué lors de l'inscription
  used      Boolean   @default(false)
  usedAt    DateTime?
  usedBy    String?
  expiresAt DateTime
  createdAt DateTime  @default(now())

  @@map("invitation_tokens")
}

// Quais de chargement
model Quai {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teams             Team[]
  reportsFrom       Report[] @relation("ReportFromQuai")
  reportsTo         Report[] @relation("ReportToQuai")

  @@map("quais")
}

// Clients
model Client {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reports Report[]

  @@map("clients")
}

// Signalements de palettes
model Report {
  id            String   @id @default(cuid())
  destination   String   // Description de la destination
  clientId      String?
  client        Client?  @relation(fields: [clientId], references: [id])
  fromQuaiId    String
  fromQuai      Quai     @relation("ReportFromQuai", fields: [fromQuaiId], references: [id])
  toQuaiId      String
  toQuai        Quai     @relation("ReportToQuai", fields: [toQuaiId], references: [id])
  photo         String?  // Base64 encoded image
  status        String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, SUSPENDED, ERROR
  createdById   String
  createdBy     User     @relation("ReportCreator", fields: [createdById], references: [id])
  assignedToId  String?
  assignedTo    User?    @relation("ReportAssignee", fields: [assignedToId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("reports")
}

// Type de conversation
// GLOBAL = chat global tous quais
// TEAM = chat d'équipe
// PRIVATE = message privé

// Conversations
model Conversation {
  id        String   @id @default(cuid())
  type      String   // GLOBAL, TEAM, PRIVATE
  name      String?  // Nom pour les groupes
  teamId    String?  // Pour les chats d'équipe
  team      Team?    @relation(fields: [teamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

// Participants aux conversations
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

// Messages
model Message {
  id             String       @id @default(cuid())
  content        String
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
  createdAt      DateTime     @default(now())

  // Relations
  readBy MessageRead[]

  @@map("messages")
}

// Messages lus
model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@map("message_reads")
}
